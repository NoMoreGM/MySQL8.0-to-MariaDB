# å¸è½½mysql
# Uninstall MySQL
systemctl stop mysql
apt remove --purge mysql-server mysql-client mysql-common -y
# å†æ¬¡ç¡®è®¤å·²å¤‡ä»½åˆ°äº‘ å†ç»§ç»­
# Check again whether having backup on your cloud then continue
rm -rf /var/lib/mysql

apt autoremove -y
apt autoclean

# å®‰è£…mariaDB
# Install MariaDB
apt update
apt install mariadb-server -y

systemctl enable mariadb
systemctl restart mariadb

# å®‰å…¨åˆå§‹åŒ–
# Secure initialization
mysql_secure_installation

# æ‰“é¸¡è¡€ã€æš‚æ—¶ è¿ç§»å®ŒæˆåŽ å»ºè®®æ’¤é”€ è®©mariaDb è‡ªåŠ¨ç®¡ç†ã€‘
# Boost performance temporarily ã€Recommend removing after migration to let MariaDB auto-manageã€‘
nano /etc/mysql/mariadb.conf.d/50-server.cnf

[mysqld]
innodb_buffer_pool_size = 4G
innodb_buffer_pool_instances = 8
innodb_thread_concurrency = 8
innodb_read_io_threads = 8
innodb_write_io_threads = 8

# æ”¹mariadbé…ç½® æ”¯æŒutf8mb4
# Modify MariaDB config to support utf8mb4
nano /etc/mysql/mariadb.conf.d/50-server.cnf

[mysqld]
character-set-server = utf8mb4
collation-server = utf8mb4_general_ci
skip-character-set-client-handshake

systemctl restart mariadb

# æ”¹æ¨¡å¼ utf8mb4_bin æ”¯æŒå¯¹emojiçš„ç²¾å‡†è¯†åˆ« ä¸¥æ ¼åŒ¹é…å”¯ä¸€æ€§
# Change collation to `utf8mb4_bin` for precise emoji recognition & strict uniqueness checks
sed -i 's/utf8mb4_0900_ai_ci/utf8mb4_bin/g' my_extended.sql

# å–æ¶ˆä»»æ„æˆªæ–­ å¦‚æžœä½ æœ‰å”¯ä¸€ç´¢å¼• è®©mariadb ä¼˜åŒ–æ‚¨çš„å”¯ä¸€æ€§ç´¢å¼• ä¼˜åŒ–ä¸ºusing hash
# Disable silent truncation & optimize UNIQUE indexes by switching to `USING HASH`
sed -i 's/UNIQUE KEY `uniq_a_b` (`a` *(123) *, *`b` *(456))/UNIQUE KEY `uniq_a_b` (`a`, `b`)/g' my_extended.sql

# æ‰§è¡Œè¿ç§»
# Execute migration
pv my_extended.sql | mariadb -u root

# å®‰è£… opensearch 2.15.0 + ik ä»£æ›¿ ngramå…¨æ–‡ç´¢å¼•
# Install OpenSearch 2.15.0 + IK tokenizer as a replacement for N-gram full-text search
# ã€æš‚ç”¨ é•œåƒã€‘
# ã€Temporary mirror solutionã€‘
docker pull swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/opensearchproject/opensearch:2.15.0
# ã€æ‰“ æ ‡ç­¾ã€‘
# ã€Tag the imageã€‘
docker tag swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/opensearchproject/opensearch:2.15.0 opensearchproject/opensearch:2.15.0
# ã€åˆå§‹åŒ– ä¾‹å­ä¸­ Xms512m Xmx512m å¯è‡ªç”±è°ƒæ•´ã€‘
# ã€Initialize OpenSearch (Example: Xms512m Xmx512m, adjust freely)ã€‘
mkdir /var/lib/opensearch/data
chown -R 1000:1000 /var/lib/opensearch/data
docker run -d --name opensearch \
  -p 9200:9200 -p 9600:9600 \
  -v /var/lib/opensearch/data:/usr/share/opensearch/data \
  -e "discovery.type=single-node" \
  -e "OPENSEARCH_INITIAL_ADMIN_PASSWORD=YourP@ssw0rd!" \
  -e "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m" \
  --restart unless-stopped opensearchproject/opensearch:2.15.0
# ã€ä½¿ç”¨https ä½†å¿½ç•¥è¯ä¹¦ã€‘
# ã€Use HTTPS but ignore SSL certificateã€‘
curl -k -u 'admin:YourP@ssw0rd!' -X GET "https://localhost:9200"
# ã€å®‰è£… ikæ’ä»¶ åˆ‡è®°ä¸¥æ ¼æ ¸å¯¹æ¥æº infinilabsã€‘
# ã€Install the IK tokenizer plugin (verify the source: InfiniLabs)ã€‘
docker exec -it opensearch bash
bin/opensearch-plugin install https://get.infini.cloud/opensearch/analysis-ik/2.15.0
exit
docker restart opensearch

# å¯¹äºŽpython pipå®‰è£…  asyncmy é€‚é…mariadb
# For Python: Install `asyncmy` to well support MariaDB
pip install asyncmy

# æ‰¹é‡å¸è½½æ— ç”¨æ’ä»¶
# Remove unnecessary plugins
docker exec -it opensearch bash -c '
for plugin in \
opensearch-alerting \
opensearch-anomaly-detection \
opensearch-asynchronous-search \
opensearch-cross-cluster-replication \
opensearch-custom-codecs \
opensearch-flow-framework \
opensearch-geospatial \
opensearch-index-management \
opensearch-job-scheduler \
opensearch-knn \
opensearch-ml \
opensearch-neural-search \
opensearch-notifications \
opensearch-notifications-core \
opensearch-observability \
opensearch-performance-analyzer \
opensearch-reports-scheduler \
opensearch-security-analytics \
opensearch-skills \
opensearch-sql; do
  echo "ðŸš® Removing $plugin ..."
  ./bin/opensearch-plugin remove "$plugin"
done
'

docker restart opensearch

# ç¦ç”¨ Lucene çš„ mmap å†™ç¼“å­˜ï¼Œé˜²æ­¢å†…å­˜â€œè½¯æ³„æ¼â€
# Disable Lucene mmap (to reduce RAM waste)
docker exec -it opensearch bash
echo "-Dlucene.disable.mmap=true" >> config/jvm.options
docker restart opensearch
